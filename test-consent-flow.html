<!DOCTYPE html>
<html>
<head>
    <title>Consent Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>Consent Flow Test</h1>
    
    <div class="test">
        <h2>1. Check localStorage</h2>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <pre id="localStorage-result"></pre>
    </div>
    
    <div class="test">
        <h2>2. Test Consent API (POST)</h2>
        <button onclick="testConsentPost()">Test POST /api/consent</button>
        <pre id="post-result"></pre>
    </div>
    
    <div class="test">
        <h2>3. Test Consent Check (GET)</h2>
        <input type="text" id="sessionId" placeholder="Session ID (optional)">
        <button onclick="testConsentGet()">Test GET /api/consent</button>
        <pre id="get-result"></pre>
    </div>
    
    <div class="test">
        <h2>4. Clear localStorage</h2>
        <button onclick="clearConsent()">Clear Consent</button>
        <pre id="clear-result"></pre>
    </div>
    
    <div class="test">
        <h2>5. Full Flow Test</h2>
        <button onclick="testFullFlow()">Test Full Flow</button>
        <pre id="flow-result"></pre>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.parentElement.className = `test ${isError ? 'error' : 'success'}`;
        }

        function checkLocalStorage() {
            try {
                const data = localStorage.getItem('flyr-consent-session');
                if (data) {
                    const parsed = JSON.parse(data);
                    log('localStorage-result', JSON.stringify(parsed, null, 2));
                } else {
                    log('localStorage-result', 'No consent data in localStorage');
                }
            } catch (error) {
                log('localStorage-result', `Error: ${error.message}`, true);
            }
        }

        async function testConsentPost() {
            try {
                const response = await fetch('/api/consent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'agreed'
                    })
                });
                
                const data = await response.json();
                log('post-result', `Status: ${response.status}\n${JSON.stringify(data, null, 2)}`, !response.ok);
            } catch (error) {
                log('post-result', `Error: ${error.message}`, true);
            }
        }

        async function testConsentGet() {
            try {
                const sessionId = document.getElementById('sessionId').value;
                const url = sessionId ? `/api/consent?sessionId=${sessionId}` : '/api/consent';
                
                const response = await fetch(url);
                const data = await response.json();
                
                log('get-result', `Status: ${response.status}\n${JSON.stringify(data, null, 2)}`, !response.ok);
            } catch (error) {
                log('get-result', `Error: ${error.message}`, true);
            }
        }

        function clearConsent() {
            localStorage.removeItem('flyr-consent-session');
            log('clear-result', 'Consent cleared from localStorage');
        }

        async function testFullFlow() {
            let results = [];
            
            // Step 1: Clear localStorage
            localStorage.removeItem('flyr-consent-session');
            results.push('1. Cleared localStorage');
            
            // Step 2: Record consent
            try {
                const postResponse = await fetch('/api/consent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'agreed' })
                });
                const postData = await postResponse.json();
                results.push(`2. POST consent: ${postResponse.status} - ${postData.message || postData.error}`);
                
                if (postData.sessionId) {
                    // Step 3: Save to localStorage
                    localStorage.setItem('flyr-consent-session', JSON.stringify({
                        sessionId: postData.sessionId,
                        expiresAt: postData.expiresAt,
                        timestamp: new Date().toISOString()
                    }));
                    results.push('3. Saved to localStorage');
                    
                    // Step 4: Check consent
                    const getResponse = await fetch(`/api/consent?sessionId=${postData.sessionId}`);
                    const getData = await getResponse.json();
                    results.push(`4. GET consent: ${getResponse.status} - Has consent: ${getData.hasConsent}`);
                }
            } catch (error) {
                results.push(`Error: ${error.message}`);
            }
            
            log('flow-result', results.join('\n'));
        }
    </script>
</body>
</html>